import {
  Controller,
  Post,
  Get,
  Put,
  Body,
  Param,
  Query,
  UseGuards,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiResponse,
  ApiBearerAuth,
  ApiQuery,
} from '@nestjs/swagger';
import { PlayerService } from './player.service';
import {
  CreatePlayerDto,
  UpdatePlayerStatsDto,
  PlayerResponseDto,
  PlayersListResponseDto,
} from '../common/dto/player.dto';
import { AnalyzeNewClipsDto } from '../common/dto/new-clip.dto';
import { GameDataDto } from '../common/dto/game-data.dto';
import { StatsManagementService } from '../common/services/stats-management.service';
// import { TeamSeasonStatsAnalyzerService } from '../team/team-season-stats-analyzer.service';
import { JwtAuthGuard } from '../common/guards/jwt-auth.guard';
import { User } from '../common/decorators/user.decorator';

@ApiTags('Player')
@Controller('player')
export class PlayerController {
  constructor(
    private readonly playerService: PlayerService,
    private readonly statsManagementService: StatsManagementService,
    // private readonly teamSeasonStatsService: TeamSeasonStatsAnalyzerService,
  ) {}

  @Post('reset-all')
  @ApiOperation({ summary: 'ëª¨ë“  ì„ ìˆ˜ ë°ì´í„° ì´ˆê¸°í™”' })
  @ApiResponse({ status: 200, description: 'ì´ˆê¸°í™” ì„±ê³µ' })
  @HttpCode(HttpStatus.OK)
  async resetAllPlayers() {
    console.log('ğŸ”„ ëª¨ë“  ì„ ìˆ˜ ë°ì´í„° ì´ˆê¸°í™” ìš”ì²­');
    
    try {
      const result = await this.playerService.resetAllPlayerData();
      return {
        success: true,
        message: `${result.deletedCount}ëª…ì˜ ì„ ìˆ˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`,
        deletedCount: result.deletedCount,
      };
    } catch (error) {
      console.error('âŒ ì„ ìˆ˜ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      return {
        success: false,
        message: 'ì„ ìˆ˜ ë°ì´í„° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        error: error.message,
      };
    }
  }

  @Post()
  @UseGuards(JwtAuthGuard)
  @ApiBearerAuth()
  @ApiOperation({ summary: 'ì„ ìˆ˜ ìƒì„±' })
  @ApiResponse({ status: 201, description: 'ì„ ìˆ˜ ìƒì„± ì„±ê³µ' })
  async createPlayer(
    @Body() createPlayerDto: CreatePlayerDto,
    @User() user: any,
  ) {
    // ì„ì‹œë¡œ ì²« ë²ˆì§¸ íŒ€ ID ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ìš”ì²­ì—ì„œ ë°›ì•„ì•¼ í•¨)
    const teamId = '507f1f77bcf86cd799439011'; // ì„ì‹œ ObjectId
    return this.playerService.createPlayer(createPlayerDto, teamId);
  }

  @Get('code/:playerId')
  @ApiOperation({ summary: 'PlayerCodeë¡œ ê°œë³„ ì„ ìˆ˜ ì¡°íšŒ' })
  @ApiResponse({
    status: 200,
    description: 'ì„ ìˆ˜ ì¡°íšŒ ì„±ê³µ',
    type: PlayerResponseDto,
  })
  @ApiResponse({ status: 404, description: 'ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ' })
  async getPlayerByCode(@Param('playerId') playerId: string) {
    return this.playerService.getPlayerByCode(playerId);
  }

  @Get('position/:position')
  @ApiOperation({ summary: 'í¬ì§€ì…˜ë³„ ì„ ìˆ˜ ëª©ë¡ ì¡°íšŒ' })
  @ApiQuery({ name: 'league', required: false, enum: ['1ë¶€', '2ë¶€'] })
  @ApiResponse({
    status: 200,
    description: 'í¬ì§€ì…˜ë³„ ì„ ìˆ˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ',
    type: PlayersListResponseDto,
  })
  async getPlayersByPosition(
    @Param('position') position: string,
    @Query('league') league?: string,
  ) {
    return this.playerService.getPlayersByPosition(position, league);
  }

  @Get('rankings')
  @ApiOperation({ summary: 'ì „ì²´ ì„ ìˆ˜ ìŠ¤íƒ¯ ë­í‚¹ ì¡°íšŒ' })
  @ApiQuery({ name: 'league', required: false, enum: ['1ë¶€', '2ë¶€'] })
  @ApiQuery({ name: 'sortBy', required: false, example: 'passingYards' })
  @ApiResponse({ status: 200, description: 'ì„ ìˆ˜ ë­í‚¹ ì¡°íšŒ ì„±ê³µ' })
  async getAllPlayersRanking(
    @Query('league') league?: string,
    @Query('sortBy') sortBy?: string,
  ) {
    return this.playerService.getAllPlayersRanking(league, sortBy);
  }

  @Put(':playerId/stats')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'ì„ ìˆ˜ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸' })
  @ApiResponse({ status: 200, description: 'ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì„±ê³µ' })
  @ApiResponse({ status: 404, description: 'ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ' })
  async updatePlayerStats(
    @Param('playerId') playerId: string,
    @Body() updateStatsDto: UpdatePlayerStatsDto,
  ) {
    return this.playerService.updatePlayerStats(playerId, updateStatsDto);
  }

  @Get('team/:teamId')
  @ApiOperation({ summary: 'íŒ€ë³„ ì„ ìˆ˜ ëª©ë¡ ì¡°íšŒ' })
  @ApiResponse({ status: 200, description: 'íŒ€ ì„ ìˆ˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ' })
  async getPlayersByTeam(@Param('teamId') teamId: string) {
    return this.playerService.getPlayersByTeam(teamId);
  }

  // í…ŒìŠ¤íŠ¸ìš©: ìƒ˜í”Œ ë°ì´í„° ìƒì„±
  // @Post('sample')
  // @ApiOperation({ summary: 'ìƒ˜í”Œ ì„ ìˆ˜ ë°ì´í„° ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)' })
  // @ApiResponse({ status: 201, description: 'ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì„±ê³µ' })
  // async createSamplePlayer() {
  //   const samplePlayer: CreatePlayerDto = {
  //     playerId: 'QB001',
  //     name: 'Ken Lee',
  //     jerseyNumber: 10,
  //     position: 'QB',
  //     teamName: 'TestTeam',
  //     league: '1ë¶€',
  //     season: '2024',
  //     stats: {
  //       passingYards: 200,
  //       passingTouchdowns: 5,
  //       completionPercentage: 60,
  //       passerRating: 85.5,
  //       gamesPlayed: 8,
  //       totalYards: 200,
  //       totalTouchdowns: 5,
  //     },
  //   };

  //   const teamId = '507f1f77bcf86cd799439011';
  //   return this.playerService.createPlayer(samplePlayer, teamId);
  // }

  // === ìƒˆë¡œìš´ í´ë¦½ êµ¬ì¡° ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ ===

  @Post('jersey/:jerseyNumber/analyze-new-clips')
  @ApiOperation({
    summary: 'ìƒˆë¡œìš´ í˜•ì‹ì˜ í´ë¦½ ë°ì´í„° ë¶„ì„ ë° ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸',
    description:
      'ìƒˆë¡œìš´ car/tkl í˜•ì‹ì˜ í´ë¦½ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ ì„ ìˆ˜ ìŠ¤íƒ¯ì„ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.',
  })
  @ApiResponse({
    status: 200,
    description: 'ìƒˆ í´ë¦½ ìŠ¤íƒ¯ ë¶„ì„ ë° ì—…ë°ì´íŠ¸ ì„±ê³µ',
  })
  @ApiResponse({ status: 404, description: 'ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ' })
  async updatePlayerStatsFromNewClips(
    @Param('jerseyNumber') jerseyNumber: string,
    @Body() analyzeNewClipsDto: AnalyzeNewClipsDto,
  ) {
    const jerseyNum = parseInt(jerseyNumber);
    const result = await this.playerService.updatePlayerStatsFromNewClips(
      jerseyNum,
      analyzeNewClipsDto.clips,
    );

    // íŒ€ ìŠ¤íƒ¯ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
    try {
      if (analyzeNewClipsDto.clips && analyzeNewClipsDto.clips.length > 0) {
        const gameKey = analyzeNewClipsDto.clips[0]?.clipKey || 'unknown';
        const season = '2024'; // í˜„ì¬ ì‹œì¦Œ

        // JSON ì „ì²´ì—ì„œ ê²Œì„ ì •ë³´ ì¶”ì¶œ (homeTeam, awayTeamì€ ê²Œì„ ë ˆë²¨ì— ìˆìŒ)
        // AnalyzeNewClipsDtoì— ê²Œì„ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œë¡œ í´ë¦½ì—ì„œ ì¶”ì •
        let homeTeam = 'í•œì–‘ëŒ€'; // ê¸°ë³¸ê°’
        let awayTeam = 'ì™¸ëŒ€'; // ê¸°ë³¸ê°’

        // ì‹¤ì œ JSONì—ëŠ” ê²Œì„ ë ˆë²¨ì— homeTeam, awayTeamì´ ìˆì§€ë§Œ,
        // í˜„ì¬ DTOì—ëŠ” clipsë§Œ ìˆìœ¼ë¯€ë¡œ í•˜ë“œì½”ë”©ëœ ë§¤í•‘ ì‚¬ìš©
        // TODO: DTOë¥¼ ìˆ˜ì •í•´ì„œ ê²Œì„ ì •ë³´ë„ í¬í•¨í•˜ë„ë¡ ê°œì„  í•„ìš”
        if (analyzeNewClipsDto.clips.length > 0) {
          // ì„ì‹œ ë§¤í•‘: ì‹¤ì œ JSONì˜ íŒ€ëª…ì„ DTO íŒ€ëª…ìœ¼ë¡œ ë³€í™˜
          homeTeam = 'HFBlackKnights'; // í•œêµ­ì™¸ëŒ€ ë¸”ë™ë‚˜ì´ì¸ 
          awayTeam = 'HYLions'; // í•œì–‘ëŒ€ ë¼ì´ì˜¨ì¦ˆ
        }

        // await this.teamSeasonStatsService.analyzeAndUpdateTeamStats(
        //   analyzeNewClipsDto.clips,
        //   gameKey,
        //   homeTeam,
        //   awayTeam,
        //   season,
        // );
      }
    } catch (error) {
      console.log('íŒ€ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      // íŒ€ ìŠ¤íƒ¯ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê°œì¸ ìŠ¤íƒ¯ ê²°ê³¼ëŠ” ë°˜í™˜
    }

    return result;
  }

  @Post('/analyze-game-data')
  @ApiOperation({
    summary: 'ì „ì²´ ê²Œì„ ë°ì´í„° ë¶„ì„ ë° íŒ€/ì„ ìˆ˜ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸',
    description:
      'ê²Œì„ì˜ ì „ì²´ JSON ë°ì´í„°ë¥¼ ë°›ì•„ì„œ í™ˆíŒ€/ì–´ì›¨ì´íŒ€ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•˜ê³  ëª¨ë“  ì„ ìˆ˜ ë° íŒ€ ìŠ¤íƒ¯ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.',
  })
  @ApiResponse({
    status: 200,
    description: 'ê²Œì„ ë°ì´í„° ë¶„ì„ ë° ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì„±ê³µ',
  })
  @ApiResponse({ status: 400, description: 'ì˜ëª»ëœ ê²Œì„ ë°ì´í„° í˜•ì‹' })
  async analyzeGameData(@Body() gameData: GameDataDto) {
    console.log('ê²Œì„ ë°ì´í„° ë¶„ì„ ì‹œì‘:', gameData.gameKey);
    console.log('í™ˆíŒ€:', gameData.homeTeam, 'ì–´ì›¨ì´íŒ€:', gameData.awayTeam);
    console.log('í´ë¦½ ê°œìˆ˜:', gameData.Clips?.length);

    const results = {
      gameKey: gameData.gameKey,
      homeTeam: gameData.homeTeam,
      awayTeam: gameData.awayTeam,
      clipsProcessed: gameData.Clips?.length || 0,
      playerStatsUpdated: 0,
      teamStatsUpdated: false,
      errors: [] as string[],
    };

    try {
      // ClipAnalyzerë¥¼ ì‚¬ìš©í•œ ì˜¬ë°”ë¥¸ QB ë¶„ì„
      const clipResult = await this.playerService.analyzeGameData(gameData);
      if (clipResult.success) {
        results.playerStatsUpdated = clipResult.qbCount || 0;
        results.teamStatsUpdated = true;
      }

      // ê¸°ì¡´ ë¡œì§ì€ ì£¼ì„ ì²˜ë¦¬
      /*if (gameData.Clips && gameData.Clips.length > 0) {
        const allPlayers = new Set<number>();

        // ëª¨ë“  í´ë¦½ì—ì„œ ê´€ë ¨ëœ ì„ ìˆ˜ë“¤ì˜ ì €ì§€ ë²ˆí˜¸ ìˆ˜ì§‘
        gameData.Clips.forEach((clip) => {
          if (clip.car?.num) allPlayers.add(clip.car.num);
          if (clip.car2?.num) allPlayers.add(clip.car2.num);
          if (clip.tkl?.num) allPlayers.add(clip.tkl.num);
          if (clip.tkl2?.num) allPlayers.add(clip.tkl2.num);
        });

        console.log('ê´€ë ¨ëœ ì„ ìˆ˜ë“¤:', Array.from(allPlayers));

        // í™ˆíŒ€ê³¼ ì–´ì›¨ì´íŒ€ ì„ ìˆ˜ë“¤ì„ ë¶„ë¦¬í•´ì„œ ì²˜ë¦¬
        const homePlayerNumbers = new Set<number>();
        const awayPlayerNumbers = new Set<number>();

        // í´ë¦½ë³„ë¡œ í™ˆíŒ€/ì–´ì›¨ì´íŒ€ ì„ ìˆ˜ë“¤ ë¶„ë¥˜
        gameData.Clips.forEach((clip) => {
          if (clip.offensiveTeam === 'Home') {
            if (clip.car?.num) homePlayerNumbers.add(clip.car.num);
            if (clip.car2?.num) homePlayerNumbers.add(clip.car2.num);
          } else if (clip.offensiveTeam === 'Away') {
            if (clip.car?.num) awayPlayerNumbers.add(clip.car.num);
            if (clip.car2?.num) awayPlayerNumbers.add(clip.car2.num);
          }

          // ìˆ˜ë¹„ ì„ ìˆ˜ë“¤ì€ ìƒëŒ€íŒ€ ê³µê²© ì‹œ ë‚˜íƒ€ë‚¨
          if (clip.offensiveTeam === 'Home') {
            if (clip.tkl?.num) awayPlayerNumbers.add(clip.tkl.num);
            if (clip.tkl2?.num) awayPlayerNumbers.add(clip.tkl2.num);
          } else if (clip.offensiveTeam === 'Away') {
            if (clip.tkl?.num) homePlayerNumbers.add(clip.tkl.num);
            if (clip.tkl2?.num) homePlayerNumbers.add(clip.tkl2.num);
          }
        });

        console.log(
          `í™ˆíŒ€(${gameData.homeTeam}) ì„ ìˆ˜ë“¤:`,
          Array.from(homePlayerNumbers),
        );
        console.log(
          `ì–´ì›¨ì´íŒ€(${gameData.awayTeam}) ì„ ìˆ˜ë“¤:`,
          Array.from(awayPlayerNumbers),
        );

        // í™ˆíŒ€ ì„ ìˆ˜ë“¤ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
        for (const jerseyNumber of homePlayerNumbers) {
          try {
            const result =
              await this.playerService.updatePlayerStatsFromNewClips(
                jerseyNumber,
                gameData.Clips,
                gameData.homeTeam,
              );
            if (result.success !== false) {
              results.playerStatsUpdated++;
            }
          } catch (error) {
            console.error(
              `í™ˆíŒ€ ì„ ìˆ˜ ${jerseyNumber} ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`,
              error,
            );
            results.errors.push(`í™ˆíŒ€ ì„ ìˆ˜ ${jerseyNumber}: ${error.message}`);
          }
        }

        // ì–´ì›¨ì´íŒ€ ì„ ìˆ˜ë“¤ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
        for (const jerseyNumber of awayPlayerNumbers) {
          try {
            const result =
              await this.playerService.updatePlayerStatsFromNewClips(
                jerseyNumber,
                gameData.Clips,
                gameData.awayTeam,
              );
            if (result.success !== false) {
              results.playerStatsUpdated++;
            }
          } catch (error) {
            console.error(
              `ì–´ì›¨ì´íŒ€ ì„ ìˆ˜ ${jerseyNumber} ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`,
              error,
            );
            results.errors.push(
              `ì–´ì›¨ì´íŒ€ ì„ ìˆ˜ ${jerseyNumber}: ${error.message}`,
            );
          }
        }
      } */

      // íŒ€ ìŠ¤íƒ¯ì€ ClipAnalyzerì—ì„œ ì²˜ë¦¬ë¨
      console.log('íŒ€ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } catch (error) {
      console.error('ê²Œì„ ë°ì´í„° ë¶„ì„ ì¤‘ ì „ì²´ ì˜¤ë¥˜:', error);
      results.errors.push(`ì „ì²´ ë¶„ì„: ${error.message}`);
    }

    return {
      success: results.errors.length === 0,
      message: `ê²Œì„ ${gameData.gameKey} ë¶„ì„ ì™„ë£Œ`,
      data: results,
    };
  }

  @Post('jersey/:jerseyNumber/analyze-new-clips-only')
  @ApiOperation({
    summary: 'ìƒˆë¡œìš´ í˜•ì‹ì˜ í´ë¦½ ë°ì´í„° ë¶„ì„ë§Œ (DB ì—…ë°ì´íŠ¸ ì•ˆí•¨)',
    description:
      'ìƒˆë¡œìš´ car/tkl í˜•ì‹ì˜ í´ë¦½ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì˜ˆìƒ ìŠ¤íƒ¯ì„ ë°˜í™˜í•˜ì§€ë§Œ DBì—ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
  })
  @ApiResponse({ status: 200, description: 'ìƒˆ í´ë¦½ ìŠ¤íƒ¯ ë¶„ì„ ì„±ê³µ' })
  @ApiResponse({ status: 404, description: 'ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ' })
  async analyzeNewClipsOnly(
    @Param('jerseyNumber') jerseyNumber: string,
    @Body() analyzeNewClipsDto: AnalyzeNewClipsDto,
  ) {
    const jerseyNum = parseInt(jerseyNumber);
    // analyzeNewClipsOnly ë©”ì„œë“œëŠ” ì œê±°ë¨ - updatePlayerStatsFromNewClips ì‚¬ìš©
    return this.playerService.updatePlayerStatsFromNewClips(
      jerseyNum,
      analyzeNewClipsDto.clips,
    );
  }

  @Post('update-game-stats')
  @ApiOperation({
    summary: 'ê²Œì„ë³„ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸',
    description:
      'ìƒˆë¡œìš´ í˜•ì‹ì˜ í´ë¦½ ë°ì´í„°ë¡œ ê²Œì„ì˜ ëª¨ë“  ì„ ìˆ˜ ìŠ¤íƒ¯ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.',
  })
  @ApiResponse({ status: 200, description: 'ê²Œì„ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ì„±ê³µ' })
  async updateGameStats(@Body() gameData: any) {
    console.log('ë°›ì€ ë°ì´í„° êµ¬ì¡°:', JSON.stringify(gameData, null, 2));
    return this.playerService.analyzeGameData(gameData);
  }

  // === 3ë‹¨ê³„ ìŠ¤íƒ¯ ê´€ë¦¬ ì‹œìŠ¤í…œ ì—”ë“œí¬ì¸íŠ¸ ===

  @Get('jersey/:jerseyNumber/game-stats')
  @ApiOperation({
    summary: 'ì„ ìˆ˜ì˜ ê²Œì„ë³„ ìŠ¤íƒ¯ ì¡°íšŒ',
    description: 'íŠ¹ì • ì„ ìˆ˜ì˜ ëª¨ë“  ê²Œì„ë³„ ê°œë³„ ìŠ¤íƒ¯ì„ ì¡°íšŒí•©ë‹ˆë‹¤.',
  })
  @ApiQuery({
    name: 'season',
    required: false,
    description: 'íŠ¹ì • ì‹œì¦Œ í•„í„°ë§',
  })
  @ApiResponse({ status: 200, description: 'ê²Œì„ë³„ ìŠ¤íƒ¯ ì¡°íšŒ ì„±ê³µ' })
  async getPlayerGameStats(
    @Param('jerseyNumber') jerseyNumber: string,
    @Query('season') season?: string,
  ) {
    const jerseyNum = parseInt(jerseyNumber);
    return this.statsManagementService.getPlayerGameStats(jerseyNum, season);
  }

  @Get('jersey/:jerseyNumber/season-stats')
  @ApiOperation({
    summary: 'ì„ ìˆ˜ì˜ ì‹œì¦Œë³„ ìŠ¤íƒ¯ ì¡°íšŒ',
    description: 'íŠ¹ì • ì„ ìˆ˜ì˜ ì‹œì¦Œë³„ ëˆ„ì  ìŠ¤íƒ¯ì„ ì¡°íšŒí•©ë‹ˆë‹¤.',
  })
  @ApiQuery({
    name: 'season',
    required: false,
    description: 'íŠ¹ì • ì‹œì¦Œ í•„í„°ë§',
  })
  @ApiResponse({ status: 200, description: 'ì‹œì¦Œë³„ ìŠ¤íƒ¯ ì¡°íšŒ ì„±ê³µ' })
  async getPlayerSeasonStats(
    @Param('jerseyNumber') jerseyNumber: string,
    @Query('season') season?: string,
  ) {
    const jerseyNum = parseInt(jerseyNumber);
    return this.statsManagementService.getPlayerSeasonStats(jerseyNum, season);
  }

  @Get('jersey/:jerseyNumber/career-stats')
  @ApiOperation({
    summary: 'ì„ ìˆ˜ì˜ ì»¤ë¦¬ì–´ ìŠ¤íƒ¯ ì¡°íšŒ',
    description: 'íŠ¹ì • ì„ ìˆ˜ì˜ ì „ì²´ ì»¤ë¦¬ì–´ ëˆ„ì  ìŠ¤íƒ¯ì„ ì¡°íšŒí•©ë‹ˆë‹¤.',
  })
  @ApiResponse({ status: 200, description: 'ì»¤ë¦¬ì–´ ìŠ¤íƒ¯ ì¡°íšŒ ì„±ê³µ' })
  async getPlayerCareerStats(@Param('jerseyNumber') jerseyNumber: string) {
    const jerseyNum = parseInt(jerseyNumber);
    return this.statsManagementService.getPlayerCareerStats(jerseyNum);
  }

  @Get('season-rankings/:season/:league')
  @ApiOperation({
    summary: 'ì‹œì¦Œ ë¦¬ê·¸ë³„ ë­í‚¹ ì¡°íšŒ',
    description: 'íŠ¹ì • ì‹œì¦Œ ë° ë¦¬ê·¸ì—ì„œì˜ ì„ ìˆ˜ ë­í‚¹ì„ ì¡°íšŒí•©ë‹ˆë‹¤.',
  })
  @ApiQuery({ name: 'position', required: false, description: 'í¬ì§€ì…˜ í•„í„°ë§' })
  @ApiQuery({ name: 'sortBy', required: false, description: 'ì •ë ¬ ê¸°ì¤€ ìŠ¤íƒ¯' })
  @ApiResponse({ status: 200, description: 'ì‹œì¦Œ ë­í‚¹ ì¡°íšŒ ì„±ê³µ' })
  async getSeasonRankings(
    @Param('season') season: string,
    @Param('league') league: string,
    @Query('position') position?: string,
    @Query('sortBy') sortBy?: string,
  ) {
    return this.statsManagementService.getSeasonRankings(
      season,
      league,
      position,
      sortBy,
    );
  }

  @Get('career-rankings')
  @ApiOperation({
    summary: 'ì»¤ë¦¬ì–´ ë­í‚¹ ì¡°íšŒ',
    description: 'í™œì„± ì„ ìˆ˜ë“¤ì˜ ì»¤ë¦¬ì–´ ì „ì²´ ë­í‚¹ì„ ì¡°íšŒí•©ë‹ˆë‹¤.',
  })
  @ApiQuery({ name: 'position', required: false, description: 'í¬ì§€ì…˜ í•„í„°ë§' })
  @ApiQuery({ name: 'sortBy', required: false, description: 'ì •ë ¬ ê¸°ì¤€ ìŠ¤íƒ¯' })
  @ApiResponse({ status: 200, description: 'ì»¤ë¦¬ì–´ ë­í‚¹ ì¡°íšŒ ì„±ê³µ' })
  async getCareerRankings(
    @Query('position') position?: string,
    @Query('sortBy') sortBy?: string,
  ) {
    return this.statsManagementService.getCareerRankings(position, sortBy);
  }

  @Post('game-stats-batch')
  @ApiOperation({
    summary: 'ê²Œì„ ì „ì²´ ì„ ìˆ˜ ìŠ¤íƒ¯ ì¼ê´„ ì—…ë°ì´íŠ¸',
    description: 'í•œ ê²Œì„ì˜ ëª¨ë“  ì°¸ì—¬ ì„ ìˆ˜ë“¤ì˜ ìŠ¤íƒ¯ì„ ì¼ê´„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.',
  })
  @ApiResponse({ status: 200, description: 'ê²Œì„ ìŠ¤íƒ¯ ì¼ê´„ ì—…ë°ì´íŠ¸ ì„±ê³µ' })
  async updateGameStatsBatch(
    @Body()
    batchData: {
      gameKey: string;
      gameDate: string;
      homeTeam: string;
      awayTeam: string;
      playersStats: Array<{
        playerNumber: number;
        analyzedStats: any;
      }>;
    },
  ) {
    const gameDate = new Date(batchData.gameDate);
    return this.statsManagementService.updateMultiplePlayersGameStats(
      batchData.gameKey,
      gameDate,
      batchData.homeTeam,
      batchData.awayTeam,
      batchData.playersStats,
    );
  }

  @Post('reset-all-stats')
  @ApiOperation({
    summary: 'ëª¨ë“  ì„ ìˆ˜ ìŠ¤íƒ¯ ì´ˆê¸°í™”',
    description: 'ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ì„ ìˆ˜ ìŠ¤íƒ¯ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.',
  })
  @ApiResponse({ status: 200, description: 'ìŠ¤íƒ¯ ì´ˆê¸°í™” ì„±ê³µ' })
  async resetAllPlayersStats() {
    return this.playerService.resetAllPlayersStats();
  }

  @Post('reset-processed-games')
  @ApiOperation({
    summary: 'ì²˜ë¦¬ëœ ê²Œì„ ëª©ë¡ ì´ˆê¸°í™”',
    description: 'JSON ì¤‘ë³µ ì…ë ¥ ë°©ì§€ë¥¼ ìœ„í•œ ì²˜ë¦¬ëœ ê²Œì„ ëª©ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.',
  })
  @ApiResponse({ status: 200, description: 'ì²˜ë¦¬ëœ ê²Œì„ ëª©ë¡ ì´ˆê¸°í™” ì„±ê³µ' })
  async resetProcessedGames() {
    return this.playerService.resetProcessedGames();
  }

  @Post('reset-team-stats/:season')
  @ApiOperation({
    summary: 'ğŸ”„ íŒ€ ì‹œì¦Œ ìŠ¤íƒ¯ ì´ˆê¸°í™”',
    description: 'íŠ¹ì • ì‹œì¦Œì˜ ëª¨ë“  íŒ€ ìŠ¤íƒ¯ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)',
  })
  @ApiResponse({ status: 200, description: 'íŒ€ ì‹œì¦Œ ìŠ¤íƒ¯ ì´ˆê¸°í™” ì„±ê³µ' })
  async resetTeamStats(@Param('season') season: string = '2024') {
    try {
      const result =
        // await this.teamSeasonStatsService.resetTeamSeasonStats(season);
        await this.statsManagementService.resetTeamStats(season);

      return {
        ...result,
        timestamp: new Date().toISOString(),
      };
    } catch (error) {
      return {
        success: false,
        message: 'íŒ€ ì‹œì¦Œ ìŠ¤íƒ¯ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        timestamp: new Date().toISOString(),
      };
    }
  }
}
